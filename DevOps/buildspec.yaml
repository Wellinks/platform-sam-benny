version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: latest
    commands:
      - echo "Updating system packages..."
      - yum update -y
      - echo "Installing dependencies..."
      - yum install -y unzip tar gzip

      - echo "Checking and Updating AWS CLI..."
      - if aws --version; then 
          echo "AWS CLI already installed. Updating..."; 
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip";
          unzip -q awscliv2.zip;
          sudo ./aws/install --update;
          rm -rf awscliv2.zip aws;
        else 
          echo "AWS CLI not found. Installing...";
          curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip";
          unzip -q awscliv2.zip;
          sudo ./aws/install;
          rm -rf awscliv2.zip aws;
        fi

      - echo "Checking and Updating AWS SAM CLI..."
      - if sam --version; then 
          echo "SAM CLI already installed. Updating..."; 
          curl -Lo aws-sam-cli-linux-x86_64.zip https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip;
          unzip -q aws-sam-cli-linux-x86_64.zip -d sam-installation;
          sudo ./sam-installation/install;
          rm -rf aws-sam-cli-linux-x86_64.zip sam-installation;
        else 
          echo "SAM CLI not found. Installing...";
          curl -Lo aws-sam-cli-linux-x86_64.zip https://github.com/aws/aws-sam-cli/releases/latest/download/aws-sam-cli-linux-x86_64.zip;
          unzip -q aws-sam-cli-linux-x86_64.zip -d sam-installation;
          sudo ./sam-installation/install;
          rm -rf aws-sam-cli-linux-x86_64.zip sam-installation;
        fi

      - export PATH=$PATH:/usr/local/bin

  pre_build:
    commands:
      - echo "Verifying AWS CLI and SAM CLI installation..."
      - aws --version
      - sam --version
      - echo "AWS CLI and SAM CLI are configured successfully."
      - echo "Using environment:$ENVIRONMENT"

  build:
    commands:
      - echo "Deploying first phase (without Lambda permissions)..."
      - sam build
      - sam deploy --config-env $ENVIRONMENT --parameter-overrides Environment=$ENVIRONMENT AuthId=NONE --no-fail-on-empty-changeset 

      - echo "Waiting for API Gateway creation..."
      - sleep 60 

      - echo "Fetching API Gateway ID..."
      - |
        API_ID=$(aws apigateway get-rest-apis --query "items[?name=='wellinksauth-$ENVIRONMENT-api'].id" --output text)
        echo "API Gateway ID: $API_ID"
        echo "API_ID=$API_ID" >> /tmp/env_variables.sh  # Save API ID for later use

      - echo "Fetching Authorizer IDs..."
      - |
        AUTH_ID=$(aws apigateway get-authorizers --rest-api-id $API_ID --query "items[?name=='WellinksLambdaAuthorizer'].id" --output text)
        MOBILE_AUTH_ID=$(aws apigateway get-authorizers --rest-api-id $API_ID --query "items[?name=='WellinksLambdaMobileAuthorizer'].id" --output text)
        VALIDATION_AUTH_ID=$(aws apigateway get-authorizers --rest-api-id $API_ID --query "items[?name=='WellinksLambdaValidationAuthorizer'].id" --output text)
        
        echo "Authorizer IDs: $AUTH_ID, $MOBILE_AUTH_ID, $VALIDATION_AUTH_ID"
        echo "AUTH_ID=$AUTH_ID" >> /tmp/env_variables.sh
        echo "MOBILE_AUTH_ID=$MOBILE_AUTH_ID" >> /tmp/env_variables.sh
        echo "VALIDATION_AUTH_ID=$VALIDATION_AUTH_ID" >> /tmp/env_variables.sh

      - echo "Deploying Lambda permission with dynamic Authorizer IDs..."
      - source /tmp/env_variables.sh 
      - sam deploy --config-env $ENVIRONMENT --parameter-overrides Environment=$ENVIRONMENT AuthId=$AUTH_ID MobileAuthId=$MOBILE_AUTH_ID ValidationAuthId=$VALIDATION_AUTH_ID


  post_build:
    commands:
      - echo "Sending Teams notification..."

      # Setup
      - START_TIME=$(date +%s)
      - BRANCH_NAME=${CODEBUILD_WEBHOOK_HEAD_REF##refs/heads/}
      - [ -z "$BRANCH_NAME" ] && BRANCH_NAME=$CODEBUILD_SOURCE_VERSION
      - ENVIRONMENT=${ENVIRONMENT:-staging}
      - TIMESTAMP=$(date)
      - BUILD_ID=$CODEBUILD_BUILD_ID
      - PROJECT_NAME=$CODEBUILD_PROJECT_NAME
      - AWS_REGION=$AWS_DEFAULT_REGION
      - COMMIT_HASH=$CODEBUILD_RESOLVED_SOURCE_VERSION
      - ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
      - COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an' || echo "unknown")

      # Build status (simulate real detection if needed)
      - BUILD_STATUS="‚úÖ Build Succeeded"
      # - BUILD_STATUS="‚ùå Build Failed"

      - |
        if [[ "$BUILD_STATUS" == "‚úÖ Build Succeeded" ]]; then
          CARD_COLOR="good"
        else
          CARD_COLOR="attention"
        fi

        END_TIME=$(date +%s)
        DURATION=$((END_TIME - START_TIME))
        DURATION_HUMAN=$(printf '%02dm %02ds' $((DURATION/60)) $((DURATION%60)))

        [ -z "$BRANCH_NAME" ] && BRANCH_NAME="unknown"
        [ -z "$COMMIT_AUTHOR" ] && COMMIT_AUTHOR="unknown"
        [ -z "$COMMIT_HASH" ] && COMMIT_HASH="unknown"

        BUILD_URL="https://${AWS_REGION}.console.aws.amazon.com/codesuite/codebuild/${ACCOUNT_ID}/projects/${PROJECT_NAME}/build/${BUILD_ID}?region=${AWS_REGION}"


      # Generate JSON
      - |
        cat <<EOF > teams_message.json
        {
          "type": "message",
          "attachments": [
            {
              "contentType": "application/vnd.microsoft.card.adaptive",
              "content": {
                "\$schema": "http://adaptivecards.io/schemas/adaptive-card.json",
                "type": "AdaptiveCard",
                "version": "1.4",
                "msteams": { "width": "Full" },
                "body": [
                  {
                    "type": "TextBlock",
                    "text": "üöÄ Build Notification: $PROJECT_NAME",
                    "weight": "bolder",
                    "size": "large",
                    "color": "accent"
                  },
                  {
                    "type": "TextBlock",
                    "text": "$BUILD_STATUS",
                    "size": "medium",
                    "weight": "bolder",
                    "color": "$CARD_COLOR",
                    "spacing": "small"
                  },
                  {
                    "type": "TextBlock",
                    "text": "---------------------------",
                    "spacing": "medium",
                    "separator": true
                  },
                  {
                    "type": "FactSet",
                    "facts": [
                      { "title": "üì¶ Branch:", "value": "$BRANCH_NAME" },
                      { "title": "üåé Environment:", "value": "$ENVIRONMENT" },
                      { "title": "‚è± Duration:", "value": "$DURATION_HUMAN" },
                      { "title": "üïò Timestamp:", "value": "$TIMESTAMP" },
                      { "title": "üßë‚Äçüíª Author:", "value": "$COMMIT_AUTHOR" },
                      { "title": "üî¢ Commit:", "value": "$COMMIT_HASH" }
                    ]
                  }
                ],
                "actions": [
                  {
                    "type": "Action.OpenUrl",
                    "title": "üîç View Build Logs",
                    "url": "$BUILD_URL"
                  }
                ]
              }
            }
          ]
        }
        EOF

      - echo "Generated Teams message:"
      - cat teams_message.json

      # Send to Teams
      - |
        curl -s -w "\nHTTP Status: %{http_code}\n" -o curl_response.txt \
          -X POST "https://convexityscientific.webhook.office.com/webhookb2/15efd2d6-d4ab-4f9b-813f-730e6b1b81f1@95f9de66-de17-46bf-a258-42a607447a48/IncomingWebhook/41f6bb49a5074526b81691e429162f86/81d4e23b-c2f3-4676-8d92-166fab321107/V2BKZoMkcSUdJuTm4vLAOjzKKr0bK3kcW1NgnWSF6POLI1" \
          -H "Content-Type: application/json" \
          --data "@teams_message.json"


      - cat curl_response.txt


artifacts:
  files:
    - '**/*'
